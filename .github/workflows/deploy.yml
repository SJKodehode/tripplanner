name: Deploy To Ubuntu

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || '22' }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        run: |
          set -euo pipefail
          [[ -n "${DEPLOY_HOST}" ]] || (echo "Missing secret: DEPLOY_HOST" && exit 1)
          [[ -n "${DEPLOY_USER}" ]] || (echo "Missing secret: DEPLOY_USER" && exit 1)
          [[ -n "${DEPLOY_PATH}" ]] || (echo "Missing secret: DEPLOY_PATH" && exit 1)
          [[ -n "${DEPLOY_SSH_PRIVATE_KEY}" ]] || (echo "Missing secret: DEPLOY_SSH_PRIVATE_KEY" && exit 1)

      - name: Configure SSH
        run: |
          set -euo pipefail
          install -m 700 -d ~/.ssh
          cat <<KEY > ~/.ssh/id_ed25519
          ${DEPLOY_SSH_PRIVATE_KEY}
          KEY
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${DEPLOY_PORT}" -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Sync Repository
        run: |
          set -euo pipefail
          RSYNC_RSH="ssh -i ~/.ssh/id_ed25519 -p ${DEPLOY_PORT} -o StrictHostKeyChecking=yes"
          export RSYNC_RSH
          ssh -i ~/.ssh/id_ed25519 -p "${DEPLOY_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "mkdir -p '${DEPLOY_PATH}'"
          rsync -az --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            --exclude ".env" \
            --exclude "server/uploads" \
            ./ "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/"

      - name: Remote Deploy
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_ed25519 -p "${DEPLOY_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "cd '${DEPLOY_PATH}' && chmod +x scripts/deploy-remote.sh && ./scripts/deploy-remote.sh"
